name: Build container action publishes expected container
description: Test to validate that build container action publishes expected container


runs:
  using: composite
  steps:
    - name: Initialize test
      shell: bash
      run: |
        source ${{ github.workspace }}/tests/test-reporter.sh
        initialize_test "build container action publishes expected container" "container-test"

    - name: Setup test environment
      shell: bash
      run: |
        # Save initial state
        git rev-parse HEAD > /tmp/original_head

        # Configure git identity for test commits
        git config user.name "Test User"
        git config user.email "test@example.com"

        cat > ${{ github.workspace }}/tests/container-test/Dockerfile << 'EOF'
        FROM alpine:latest
        CMD ["echo", "Test Container"]
        EOF

        git add Dockerfile
        git commit -m "Add Dockerfile"

        # Start local container registry
        docker run -d -p 5000:5000 \
            -v ${{ github.workspace }}/tests/container-registry:/auth \
            -e REGISTRY_AUTH=htpasswd \
            -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \
            -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
            --name registry registry:2

    - name: Run container action
      uses: ./container
      with:
        registryHost: localhost:5000
        registryUsername: testuser
        registryPassword: testpassword
        imageNames: localhost:5000/test-image
        context: ${{ github.workspace }}/tests/container-test
        dockerfile: ${{ github.workspace }}/tests/container-test/Dockerfile

    - name: Assert container was published
      shell: bash
      run: |
        source ${{ github.workspace }}/tests/test-reporter.sh
        set_test_name "Assert container was published"

        # Verify the container can be pulled
        docker pull localhost:5000/test-image:latest
        if [ $? -ne 0 ]; then
            failure "Failed to pull container"
            exit 1
        fi

        # Verify the container runs
        output=$(docker run --rm localhost:5000/test-image:latest)
        if [ "$output" != "Test Container" ]; then
            failure "Container output does not match expected: $output"
            exit 1
        fi

        success "Container runs correctly with expected output"

    - name: Assert semantic versioning was applied
      shell: bash
      run: |
        # Need to find expected tag so the test is correct
        # List all tags
        git_tags=$(git tag -l)
        echo "Git tags: $git_tags"

        # Check for version tag
        if ! git tag -l | grep -q "v0.0.1"; then
            failure "Expected version tag v0.0.1 not found"
            exit 1
        else
            success "Semantic version tag v0.0.1 successfully applied"
        fi

    - name: Clean up test environment
      shell: bash
      if: always()
      run: |
        # Reset repository to original state
        git reset --hard $(cat /tmp/original_head)
        git clean -fdx

    - name: Finalize test
      shell: bash
      if: always()
      run: |
        source ${{ github.workspace }}/tests/test-reporter.sh
        finalize_test

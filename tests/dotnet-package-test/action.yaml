name: Build dotnet-container action tests and publishes expected container
description: Test to validate that build dotnet-container action tests and publishes expected container

runs:
  using: composite
  steps:
    - name: Setup test environment
      shell: bash
      run: |
        # Save initial state
        git rev-parse HEAD > /tmp/original_head

        # Save the list of tags and their commits
        git tag --list | while read tag; do
            echo "$tag $(git rev-list -n 1 "$tag")"
        done > /tmp/original_tags

        # Back up existing NuGet.Config if it exists
        if [ -f "${{ github.workspace }}/NuGet.Config" ]; then
            mv "${{ github.workspace }}/NuGet.Config" "${{ github.workspace }}/NuGet.Config.bak"
        fi

        # Copy test NuGet.Config to root for the package action
        cp "${{ github.workspace }}/tests/sample-projects/half-covered/TestProject/NuGet.Config" "${{ github.workspace }}/NuGet.Config"

    - name: Debug NuGet Config
      shell: bash
      run: |
        echo "Current directory: $(pwd)"
        ls -la "${{ github.workspace }}/NuGet.Config"
        cat "${{ github.workspace }}/NuGet.Config"

    - id: version
      name: Get semantic version
      uses: spritely/actions.semantic-version/get@v0.5.2
      with:
        skipCheckout: true
        writeSummary: false

    # Works:
    # - name: Login to GitHub container registry
    #   if: inputs.registryHost != '' && inputs.registryUsername != '' && inputs.registryPassword != ''
    #   uses: docker/login-action@v3
    #   with:
    #     registry: localhost:5000
    #     username: testuser
    #     password: testpassword

    # - id: prepare
    #   name: Prepare devcontainer environment
    #   shell: bash
    #   run: |
    #     mkdir -p ./.devcontainer
    #     touch ./.devcontainer/.env

    #     # Need to copy the build script files to a path that will work inside the devcontainer
    #     # Find a path that will not conflict with user files
    #     base_dir=".github-actions-publish-nuget"
    #     temp_dir="$base_dir"
    #     counter=1

    #     # Find a unique directory name
    #     while [ -e "$temp_dir" ]; do
    #       temp_dir="${base_dir}-${counter}"
    #       counter=$((counter + 1))
    #     done

    #     # Create the directory and copy the script
    #     mkdir -p "$temp_dir"
    #     cp "${{ github.workspace }}/tests/dotnet-package-test/publish-nuget.sh" "$temp_dir/publish-nuget.sh"
    #     chmod +x "$temp_dir/publish-nuget.sh"

    #     echo "Using temporary directory: $temp_dir"

    #     # Set output variables
    #     echo "publishNuGetDirectory=$temp_dir" >> $GITHUB_OUTPUT

    # - name: Debug DevContainer Files
    #   uses: devcontainers/ci@v0.3
    #   with:
    #     runCmd: |
    #       echo "=== Files in /src ==="
    #       ls -la /src
    #       echo "=== Files in /src/.github-actions-publish-nuget ==="
    #       ls -la /src/.github-actions-publish-nuget
    #     push: never

    # - name: Publish NuGet package
    #   if: github.ref_type == 'branch'
    #   uses: devcontainers/ci@v0.3
    #   with:
    #     runCmd: |
    #       source "/src/${{ steps.prepare.outputs.publishNuGetDirectory }}/publish-nuget.sh"
    #     push: never
    #     env: |
    #       PROJECT_FILE=./tests/sample-projects/half-covered/TestProject/TestProject.csproj
    #       VERSION=${{ steps.version.outputs.version }}
    #       PACKAGE_REPOSITORY=TestRepository
    #       NUGET_TOKEN=fake-token

    # - name: Remove temporary files
    #   if: always()
    #   shell: bash
    #   run: |
    #     if [ -d "${{ steps.prepare.outputs.publishNuGetDirectory }}" ]; then
    #       rm -rf "${{ steps.prepare.outputs.publishNuGetDirectory }}"
    #       echo "Removed temporary directory: ${{ steps.prepare.outputs.publishNuGetDirectory }}"
    #     fi

    - name: Unit test with code coverage
      uses: spritely/actions.test-dotnet@v0.3.5
      with:
        nugetAuthToken: fake-token
        coverageThreshold: 50
        projectFile: ./tests/sample-projects/half-covered/TestProject/TestProject.csproj
        unitTestProjects: ./tests/sample-projects/half-covered/**/*.UnitTests.csproj
        registryUsername: testuser
        registryPassword: testpassword
        registryHost: localhost:5000
        writeSummary: false

    - name: Build and publish nuget package
      uses: spritely/actions.publish-nuget@v0.2.12
      with:
        packageRepository: TestRepository
        nugetAuthToken: fake-token
        projectFile: ./tests/sample-projects/half-covered/TestProject/TestProject.csproj
        version: ${{ steps.version.outputs.version }}
        registryUsername: testuser
        registryPassword: testpassword
        registryHost: localhost:5000

    # Broken
    # - name: Run dotnet-package action
    #   uses: ./dotnet-package
    #   with:
    #     # Use the named source from NuGet.Config
    #     packageRepository: TestRepository
    #     nugetAuthToken: fake-token
    #     projectDirectory: ./tests/sample-projects/half-covered/TestProject
    #     projectFile: TestProject.csproj
    #     unitTestProjects: ./tests/sample-projects/half-covered/**/*.UnitTests.csproj
    #     coverageThreshold: 50
    #     registryHost: localhost:5000
    #     registryUsername: testuser
    #     registryPassword: testpassword
    #     writeSummary: false

    - name: Initialize test
      shell: bash
      run: |
        source ${{ github.workspace }}/tests/test-reporter.sh
        initialize_test "build dotnet-package action tests and publishes expected package" "dotnet-package-test"

    - name: Assert package was published
      shell: bash
      run: |
        source ${{ github.workspace }}/tests/test-reporter.sh
        set_test_name "Assert package was published"

        # Query the NuGet server API to check if the package exists
        response=$(curl -s "http://localhost:5001/v3/registration/testproject/${{ steps.version.outputs.version }}.json" -o /dev/null -w "%{http_code}")

        if [ "$response" -eq 200 ]; then
            success "NuGet package v${{ steps.version.outputs.version }} was published successfully"
        else
            failure "NuGet package v${{ steps.version.outputs.version }} was not found on the server (HTTP $response)"

            # Try to get package list for debugging
            echo "Search results for 'TestProject':"
            curl -s "http://localhost:5001/v3/search?q=TestProject"
        fi

    - name: Clean up test environment
      shell: bash
      if: always()
      run: |
        # Restore NuGet.Config
        rm -f "${{ github.workspace }}/NuGet.Config"
        if [ -f "${{ github.workspace }}/NuGet.Config.bak" ]; then
            mv "${{ github.workspace }}/NuGet.Config.bak" "${{ github.workspace }}/NuGet.Config"
        fi

        # Reset repository to original state
        git reset --hard $(cat /tmp/original_head)

        # Delete any tags not in the original list
        git tag | while read tag; do
            if ! grep -q "^$tag " /tmp/original_tags; then
                echo "Deleting extra tag: $tag"
                git tag -d "$tag" 2>/dev/null || true
            fi
        done

    - name: Finalize test
      shell: bash
      if: always()
      run: |
        source ${{ github.workspace }}/tests/test-reporter.sh
        finalize_test
